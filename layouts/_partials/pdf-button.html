{{ if .Params.generate_pdf }}
<style>
  .pdf-toolbar {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    margin: 0.3rem 0 0.5rem 0; /* уменьшено */
    padding: 0; /* убрали лишнее */
    border: none; /* убрали линию */
  }

  .btn-pdf {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    font-size: 0.85rem;
    color: var(--body-font-color);
    background-color: transparent;
    border: 1px solid var(--gray-200);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-pdf:hover {
    background-color: var(--gray-100);
    border-color: var(--color-link);
    color: var(--color-link);
  }

  .btn-pdf.loading {
    opacity: 0.7;
    cursor: wait;
    pointer-events: none;
  }
</style>

<div class="pdf-toolbar">
    <button id="btn-generate-pdf" class="btn-pdf" title="Сохранить эту страницу в PDF">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="12" y2="18"></line>
            <line x1="15" y1="15" x2="12" y2="18"></line>
        </svg>
        <span>Скачать PDF</span>
    </button>
</div>


<div id="pdf-header-template" style="display: none;">
    <div style="text-align: center; margin-bottom: 25px;">
        {{ with .Site.Params.BookLogo }}
        <img src="{{ . | absURL }}" style="height: 50px; width: auto; margin-bottom: 10px;" />
        {{ end }}
        <h1 style="font-size: 24px; margin: 0 0 5px 0; color: #000;">{{ .Title }}</h1>
        <div style="font-size: 12px; color: #555;">
            Источник: {{ .Permalink }}
        </div>
    </div>
    {{ with .Description }}
    <div style="background: #f5f5f5; padding: 10px; border-left: 4px solid #333; margin-bottom: 20px; font-style: italic; font-size: 14px;">
        {{ . }}
    </div>
    {{ end }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('btn-generate-pdf');
    if (!btn) return; 

    btn.addEventListener('click', function () {
        var originalText = btn.innerHTML;
        
        btn.classList.add('loading');
        btn.innerHTML = '⏳ Создание...';

        var element = document.querySelector('.markdown');
        if (!element) {
            console.error("Content element (.markdown) not found.");
            btn.classList.remove('loading');
            btn.innerHTML = originalText;
            return;
        }

        var clone = element.cloneNode(true);
        
        var headerTemplate = document.getElementById('pdf-header-template');
        var headerClone = headerTemplate.cloneNode(true);
        headerClone.style.display = 'block';

        clone.insertBefore(headerClone, clone.firstChild);

        var opt = {
            margin:       [15, 15],
            filename:     '{{ .Title | urlize | anchorize }}.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true, logging: false },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };

        html2pdf().set(opt).from(clone).save().then(function(){
            btn.classList.remove('loading');
            btn.innerHTML = originalText;
        }).catch(function(error) {
            console.error('PDF generation failed:', error);
            btn.classList.remove('loading');
            btn.innerHTML = originalText;
            alert('Не удалось создать PDF. Проверьте консоль браузера.');
        });
    });
});
</script>
{{ end }}