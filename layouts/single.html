{{ define "main" }}

  {{/* ========= 1. WEB PAGE CONTENT (Видимый контент) ========= */}}
  <article class="markdown book-article">
    
    {{/* Сначала заголовок H1 на странице */}}
    <h1>{{ .Title }}</h1>

    {{/* ПОД заголовком - кнопка */}}
    {{ if .Params.show_pdf_button }}
      <button id="download-pdf" class="btn-pdf-download">Скачать PDF</button>
    {{ end }}

    {{/* Основной контент статьи */}}
    {{- .Content -}}
  </article>


  {{/* ========= 2. PDF CONTENT (Полностью скрытый) ========= */}}
  {{/* Этот контейнер "убран" с экрана. 
    html2pdf будет клонировать его для печати.
    Мы задаем ему ширину, чтобы макет был похож на лист A4.
  */}}
  <div id="printable-area" style="position: absolute; left: -9999px; top: 0; width: 8.5in; background: white; padding: 0.5in;">
    
    {{/* "Шапка" для PDF (Лого, URL, Описание) */}}
    <div class="pdf-header" style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px;">
      
      {{/* !!! КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ !!!
        Добавлен `crossorigin="anonymous"` для исправления ошибки "tainted canvas"
      */}}
      <img src="{{ "/logo.png" | absURL }}" crossorigin="anonymous" alt="Logo" style="max-height: 60px; margin-bottom: 15px;">
      
      <h3>{{ .Site.Title }}</h3>
      <p><strong>Адрес сайта:</strong> {{ .Site.BaseURL }}</p>
      
      {{/* Исправлено: не показываем "Описание:", если оно пустое */}}
      {{ with .Description | default .Site.Params.description }}
        <p><strong>Описание:</strong> {{ . }}</p>
      {{ end }}
    </div>

    {{/* Дубликат контента статьи для PDF */}}
    <article class="markdown book-article-pdf">
      <h1>{{ .Title }}</h1>
      {{- .Content -}}
    </article>
  </div>


  {{/* ========= 3. JAVASCRIPT (Упрощенный) ========= */}}
  {{ if .Params.show_pdf_button }}
  <script>
    document.getElementById('download-pdf').addEventListener('click', function() {

      var element = document.getElementById('printable-area');

      var opt = {
        margin:       0.5, 
        filename:     '{{ .File.BaseFileName | default "document" }}.pdf',
        image:        { type: 'jpeg', quality: 0.98 },

        html2canvas:  { scale: 2, useCORS: true }, 
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().from(element).set(opt).save();
    });
  </script>
  {{ end }}

{{ end }}